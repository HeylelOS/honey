HEADERS=-I./include/
SOURCES=$(wildcard src/*.c)
OBJECTS=$(patsubst src/%.c, $(BUILDDIR)/obj/%.o, $(SOURCES))
BIN=$(BUILDDIR)/bin/$(NAME)
BUILDDIRS=$(BUILDDIR)/ $(BUILDDIR)/obj $(BUILDDIR)/bin $(BUILDDIR)/lib
BINSOURCE=main.c

.PHONY: all doc tests clean

all: $(BUILDDIRS) $(BIN)

doc: $(BUILDDIRS)
	doxygen doc/Doxyfile
	cp -r doc/man1/ $(BUILDDIR)/man/
	mv $(BUILDDIR)/man/man3/hny.h.3 $(BUILDDIR)/man/man3/hny.3
	rm $(BUILDDIR)/man/man3/_*

tests: all
	./tests/run.sh

clean:
	rm -rf $(BUILDDIR)

$(BUILDDIR)/obj/%.o: src/%.c
	$(CC) $(CFLAGS) $(HEADERS) -fPIC -o $@ -c $<

$(BUILDDIRS):
	mkdir $@

$(OBJECTS): $(SOURCES)

$(LIB): $(OBJECTS)
	$(LD) $(SHAREDFLAG) -o $@ $^ $(LDFLAGS)

$(BIN): $(BINSOURCE) $(LIB)
	$(CC) $(CFLAGS) $(HEADERS) -o $@ $< -l$(NAME) -L./$(BUILDDIR)/lib

